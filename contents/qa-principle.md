MongoDB关系:嵌入还是引用?

问题[链接](http://stackoverflow.com/questions/5373198/mongodb-relationships-embed-or-reference)

这是一个艺术问题而非科学.[Mongo的文档结构](http://docs.mongodb.org/manual/data-modeling/)是一个不错的参考,不过这里有一些事情应该考虑:
- 尽可能的放得多
 文档数据库的快乐在于消除了很多的连接(Joins).你的第一直觉应该是在一个单独的文档中尽你所能放置数据.如果你在SQL中你需要标准化你的数据.但MongoDB本身有结构,而且你能在结构中高效查询.特别是没有用的数据,除非它的父文档是相同文档的一部分.
 
- 分离可以被多个地方索引到的数据,并让这些数据形成自己的集合.
 这不是一个"储存空间"问题而是一个"数据一致性"问题.如果很多集合索引相同的数据,会变得更高效,更不容易出错更新一条单独的记录而且在其他的地方保持索引.

- 文档大小注意事项
 MongoDB限制一个单独的文档大小是4MB(1.8版本的是16MB).在GB的世界里,这些数据听起来很小,但也是3千万条tweets,25万典型的Stack Overflow回答,20个flickr照片.另一方面,这是一个典型的web页面中人们可以接受的信息量.首先考虑什么会让你的查询变得更简单.在很多情况文档大小应当早优化.

- 复杂的数据结构:
 MongoDB可以存储任意深度的嵌套数据结构,但不可以高效搜索.乳沟你的数据来源于一个树结构,森林或者图,你需要在一个单独文档处高效存储每个节点和它们的边界.(注意有一些数据存储是为了数据类型而特别设计,这个同样也要考虑)
 同样需要[指出](http://seanhess.github.com/2012/02/01/mongodb_relational.html)可能返回一个文档中的子集元素.如果你需要在每个文档中挑拣少量信息,把他们分开来处理会更加容易些.
 
- 数据一致性
 MongoDB在效率和一致性之间做了权衡.规则是改变一个单独的文档**通常**是原子性的,但更新多个文档不应该假设是原子的.没有办法"锁"服务器中一条记录.(你可以把这些构建在客户端的逻辑中,使用例如一个"锁"字段).当你设计你的表结构要考虑如何保持数据一致性.一般来讲,在一个文档中保证越多越好.
 
对于你的描述,我会嵌入评论,之后给每个评论一个对象主键类型的id字段.这个对象主键有一个嵌套时间戳,这样你就可以使用它,而不用创建它了.

为什么MongoDB Java驱动程序在一个条件语句中使用一个随机数发生器?
问题[链接](http://stackoverflow.com/questions/16833100/why-does-the-mongodb-java-driver-use-a-random-number-generator-in-a-conditional)

检查这条历史线后,我的主要结论是已经有一些不称职的程序还在工作。

1. 这一行是无缘无故地复杂.通常是

```
a? true : b
```

对于`boolean a,b`等价于

```
a||b
```

2. 逻辑非操作符和太多的括号进一步弄乱.记住[德摩根定律](http://en.wikipedia.org/wiki/De_Morgan%27s_laws),这是一个微不足道的观察,这段代码

```
if (!_ok && Math.random() <= 0.1)
  return res;
```

3.[最初介绍了这个逻辑](https://github.com/mongodb/mongo-java-driver/commit/ee7543a4f7cc26618cf78eab2a18bd33b3e101cc)的提交

```
if (_ok == true) {
  _logger.log( Level.WARNING , "Server seen down: " + _addr, e );
} else if (Math.random() < 0.1) {
  _logger.log( Level.WARNING , "Server seen down: " + _addr );
}
```
另一个不称职代码的例子,但是请注意__反转逻辑__:在事件记录中如果`_ok`或在其他情况下的10%,而2中的代码10%的时间__返回__和90%的时间输出日志.所以后来的提交中不仅毁了清晰还有自身的正确.

我认为在您已发布的代码我们可以看出作者旨在改变原来的`if - then`,而不知怎么随便否定提前`返回`条件.但是他搞砸了,插入一个"双重否定"来扭转不等号.

4. 除了编码风格问题,随机日志本身也是相当可疑,特别是文档日志条目没有自己特有的行为。意图很明显,减少再次声明:that the server is currently down.合适的解决方案是日志只__更改__服务器的状态,并不是每一个都观察,更别说10%的随机选择这样的观察.是的,只需要一点努力,让我们看到一些改变。

我只能希望这一切不称职的证据,积累了__仅仅三行代码__,不会把这个项目作为一个整体,而这段工作将尽快清理。


> 译者注:这个就是典型的重构思想,参考马克大叔的《重构》